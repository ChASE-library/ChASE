# Add this to your .gitlab-ci.yml file
# This snippet adds documentation building to your existing CI pipeline

# Add 'docs' to the stages list:
# stages:
#   - build
#   - test
#   - coverage
#   - docs  # <-- Add this line

# Documentation build job
build_docs:
  stage: docs
  tags: [ public-docker ]
  image:
    name: xinzhewu/hpc-gcc12-openmpi5-openblas-scalapack
  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'
    - if: '$CI_COMMIT_BRANCH =~ /^v[0-9]+\.[0-9]+\.[0-9]+$/'
    - changes:
        - docs/**/*
        - CMakeLists.txt
        - docs/CMakeLists.txt
        - scripts/build_docs.sh
  before_script:
    - apt-get update -qq && apt-get install -y -qq python3 python3-pip doxygen graphviz
    - pip3 install --quiet sphinx breathe sphinx-rtd-theme
  script:
    - chmod +x scripts/build_docs.sh
    - ./scripts/build_docs.sh
  artifacts:
    paths:
      - build_docs/docs_output/
    expire_in: 1 week
    when: on_success
  only:
    - master
    - /^v[0-9]+\.[0-9]+\.[0-9]+$/  # Matches version branches like v1.3.0

