

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>ChASE with MPI+OpenMP &mdash; ChASE 0.9.1 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../_static/ChASE_Logo_Favicon_RGB.png"/>
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../theme_overrides.css" type="text/css" />
  

  
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="ChASE 0.9.1 documentation" href="../index.html"/>
        <link rel="up" title="Installation and Setup on a Cluster" href="../installation.html"/>
        <link rel="next" title="Examples" href="../example.html"/>
        <link rel="prev" title="Linking ChASE to other Application Software" href="link.html"/>
    <link href="../_static/theme_overrides.css" rel="stylesheet" type="text/css">


  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html">
          

          
            
            <img src="../_static/ChASE_Logo_RGB.png" class="logo" />
          
          </a>

          
            
            
              <div class="version">
                0.9rc
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <p class="caption"><span class="caption-text">INTRODUCTION</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../chase.html">ChASE: an Iterative Solver for Dense Eigenproblems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../version.html">Versions of the library</a></li>
<li class="toctree-l1"><a class="reference internal" href="../license.html">Licenses and Copyright</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference.html">References and Contributors</a></li>
</ul>
<p class="caption"><span class="caption-text">USER DOCUMENTATION</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../quick-start.html">Quick Start</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../installation.html">Installation and Setup on a Cluster</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../installation.html#library-dependencies">Library Dependencies</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#installation-on-cluster">Installation on Cluster</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#linking-chase">Linking ChASE</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../installation.html#recommendation-on-the-usage-of-computing-resources">Recommendation on the usage of Computing Resources</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">ChASE with MPI+OpenMP</a></li>
<li class="toctree-l3"><a class="reference internal" href="#chase-with-multi-gpus">ChASE with multi-GPUs</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../example.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../module.html">Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../parameters.html">Parameters and Configurations</a></li>
</ul>
<p class="caption"><span class="caption-text">DEVELOPER DOCUMENTATION</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../algorithm.html">General algorithm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../abstract.html">Virtual Abstract of Numerical Kernels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../parallel.html">Parallel implementations</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">ChASE</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
      
        <li><a href="../installation.html">Installation and Setup on a Cluster</a> &raquo;</li>
      
    <li>ChASE with MPI+OpenMP</li>
    <li class="wy-breadcrumbs-aside">
      
        
          <a href="../_sources/installation/suggestion.rst.txt" rel="nofollow"> View page source</a>
        
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="chase-with-mpi-openmp">
<h1>ChASE with MPI+OpenMP<a class="headerlink" href="#chase-with-mpi-openmp" title="Permalink to this headline">Â¶</a></h1>
<p>Modern homogenous supercomputers are often equipped with hunderds of thousands of nodes which
are connected with fast networks. Each node is of NUMA (Non-uniform memory access) types, which
composes several NUMA domains. Each NUMA domain has its local memory, and is able to access the
local memory of another NUMA domain within the same node. Within a
NUMA domain, a processor can access
its own local memory faster than any other non-local memory.</p>
<p>When running ChASE on modern homogenous clusters in the <code class="docutils literal notranslate"><span class="pre">MPI/OpenMP</span></code> hybrid mode, this <cite>NUMA effect</cite>
should be considered. In order to attain good performance, we recommand:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>Ensure each NUMA domain having at least 1 MPI task.</p></li>
<li><p>Bind the CPUs to the relevant MPI tasks.</p></li>
</ol>
</div></blockquote>
<p>The optimal use of resources is usually achieved by carefully
designing the script code which is used for the job submission. An
example of a job script for a  <code class="docutils literal notranslate"><span class="pre">SLURM</span></code> scheduler is given below:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># This is an example on JUWELS, in which each node is composed of 2 NUMA sockets.</span>
<span class="c1"># This example allocates 4 nodes, 8 MPI tasks, each socket has 1 task,</span>
<span class="c1"># and 24 CPUs are bound to each MPI tasks.</span>
<span class="c1">#!/bin/bash -x</span>
<span class="c1">#SBATCH --nodes=4</span>
<span class="c1">#SBATCH --ntasks=8</span>
<span class="c1">#SBATCH --ntasks-per-socket=1</span>
<span class="c1">#SBATCH --cpus-per-task=24</span>
</pre></div>
</div>
<p>An important aspect of executing ChASE on a parallel cluster is the
memory footprint of the library. It is important to avoid that such
memory footprint per MPI task exceeds the amount of main memory
available to the compiled code. To help the user to make the correct
decision in terms of resources a simple formula can be used</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="mi">16</span> <span class="o">*</span> <span class="p">[</span><span class="n">n</span> <span class="o">*</span> <span class="n">m</span> <span class="o">+</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="n">m</span> <span class="o">+</span> <span class="n">max</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="n">n</span><span class="p">))</span> <span class="o">*</span> <span class="n">block</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">N</span> <span class="o">*</span>
<span class="n">block</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="mi">1024</span><span class="o">^</span><span class="mi">3</span><span class="p">)</span> <span class="n">GigaByte</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">n</span></code> and <code class="docutils literal notranslate"><span class="pre">m</span></code> are fractions of <code class="docutils literal notranslate"><span class="pre">N</span></code> which depend on the size
of the MPI grid of precessors. For instance in the job script above
<code class="docutils literal notranslate"><span class="pre">n</span> <span class="pre">=</span> <span class="pre">N/2</span></code> and <code class="docutils literal notranslate"><span class="pre">m</span> <span class="pre">=</span> <span class="pre">N/4</span></code> (or viceversa). Correspondingly <code class="docutils literal notranslate"><span class="pre">N</span></code> is
the size of the eigenproblem and <code class="docutils literal notranslate"><span class="pre">block</span></code> is at most <code class="docutils literal notranslate"><span class="pre">nev</span> <span class="pre">+</span> <span class="pre">nex</span></code>.
Note that the factor <code class="docutils literal notranslate"><span class="pre">16</span></code> is valid for double precision floating
numbers. Using such a formula one can verify if the allocation of
resources is enough to solve for the problem at hand. For instance,
for a <code class="docutils literal notranslate"><span class="pre">N</span> <span class="pre">=</span> <span class="pre">20,000</span></code> and a <code class="docutils literal notranslate"><span class="pre">nev</span> <span class="pre">+</span> <span class="pre">nex</span> <span class="pre">=</span> <span class="pre">2,000</span></code>, the total memory per
MPI rank is <code class="docutils literal notranslate"><span class="pre">3.28</span> <span class="pre">GB</span></code>.</p>
</div>
<div class="section" id="chase-with-multi-gpus">
<h1>ChASE with multi-GPUs<a class="headerlink" href="#chase-with-multi-gpus" title="Permalink to this headline">Â¶</a></h1>
<p>Currently, ChASE is able to offload the most intensive computation (Hermitian Matrix-Matrix
Multiplications), QR factorization and Rayleigh-Ritz computation to GPUs.
The multi-GPUs version of ChASE is able to use all available cards for
each node. This multi-GPUs version supports either 1 MPI task to manage all cards or 1 MPI task
to manage only 1 binded GPU card. Some less intensive computation is also assigned to this MPI task and executed
in multi-threading mode.</p>
<p>Below is an example of a job script for a <code class="docutils literal notranslate"><span class="pre">SLURM</span></code> scheduler which allocates 1 MPI task with
multi-GPUs per node:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># This is an example on the JUWELS GPU partition, in which each node has 4 V100 NVIDIA GPUs.</span>
<span class="c1"># This example allocates 4 nodes, 4 MPI tasks, each node has 1 task,</span>
<span class="c1"># and 4 GPUs per node.</span>
<span class="c1">#!/bin/bash -x</span>
<span class="c1">#SBATCH --nodes=4</span>
<span class="c1">#SBATCH --ntasks=4</span>
<span class="c1">#SBATCH --ntasks-per-node=1</span>
<span class="c1">#SBATCH --cpus-per-task=24</span>
<span class="c1">#SBATCH --gres=gpu:4</span>
</pre></div>
</div>
<p>Below is an example of a job script for a <code class="docutils literal notranslate"><span class="pre">SLURM</span></code> scheduler which allocates
multi-GPUs per node and each GPU card bound to 1 MPI task:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># This is an example on the JUWELS GPU partition, in which each node has 4 V100 NVIDIA GPUs.</span>
<span class="c1"># This example allocates 4 nodes, 16 MPI tasks, each node has 4 task,</span>
<span class="c1"># and 4 GPUs per node, each GPU card is bound to 1 MPI task.</span>
<span class="c1">#!/bin/bash -x</span>
<span class="c1">#SBATCH --nodes=4</span>
<span class="c1">#SBATCH --ntasks=16</span>
<span class="c1">#SBATCH --ntasks-per-node=4</span>
<span class="c1">#SBATCH --cpus-per-task=24</span>
<span class="c1">#SBATCH --gres=gpu:4</span>
</pre></div>
</div>
<p>As mentiond in the previous section, it is important to make sure that
the memory footprint of the library does not exceed the memory
available on the GPU card. For instance, in the case of the last job
script (one GPU card for one MPI task) with <code class="docutils literal notranslate"><span class="pre">N</span> <span class="pre">=</span> <span class="pre">40,000</span></code> and <code class="docutils literal notranslate"><span class="pre">nev</span> <span class="pre">+</span>
<span class="pre">nex</span> <span class="pre">=</span> <span class="pre">4,000</span></code>, the memory for each MPI task, and consequently on each
GPU card, is</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="mi">16</span> <span class="o">*</span> <span class="p">[</span><span class="mi">10</span><span class="o">^</span><span class="mi">3</span> <span class="o">*</span> <span class="mi">10</span><span class="o">^</span><span class="mi">3</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="mi">10</span><span class="o">^</span><span class="mi">3</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">10</span><span class="o">^</span><span class="mi">3</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">10</span><span class="o">^</span><span class="mi">4</span> <span class="o">*</span>
<span class="mi">10</span><span class="o">^</span><span class="mi">3</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="mi">1024</span><span class="o">^</span><span class="mi">3</span><span class="p">)</span> <span class="n">GigaByte</span> <span class="o">=</span> <span class="mf">1.9</span> <span class="n">GB</span>
</pre></div>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../example.html" class="btn btn-neutral float-right" title="Examples" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="link.html" class="btn btn-neutral" title="Linking ChASE to other Application Software" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2021, SimLab Quantum Materials.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'0.9.1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="../_static/language_data.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>